openapi: 3.0.2
info:
  title: Filmogophery
  description: FilmogopheryのAPI
  version: 0.7.0v2025.12.31
  license:
    name: None
    url: None

servers:
  - url: http://127.0.0.1:8000/v1
    description: ローカル環境

tags:
  - name: Health
    description: ヘルスチェック
  - name: User
    description: ユーザー
  - name: Auth
    description: 認証・認可
  - name: Movie
    description: 映画
  - name: Trending
    description: トレンド
  - name: Review
    description: レビュー
  - name: WatchHistory
    description: 視聴履歴
  - name: Watchlist
    description: ウォッチリスト
  - name: Search
    description: 検索
  - name: Master
    description: マスタデータ

security:
  - TOKEN_HEADER: []

paths:
  /health:
    get:
      tags: [Health]
      summary: ヘルスチェック
      operationId: health
      security: []
      responses:
        200:
          description: 成功
        408:
          description: タイムアウト
        500:
          description: システムエラー

  /users:
    post:
      tags: [User]
      summary: ユーザー登録
      operationId: createUser
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUser"
      responses:
        201:
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Token"
        400:
          description: バッドリクエスト
        409:
          description: 競合

  /users/me:
    get:
      tags: [User]
      summary: ログインユーザー取得
      operationId: getCurrentUser
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        401:
          description: 未認証
        404:
          description: ユーザーなし

  /users/{userId}:
    get:
      tags: [User]
      summary: ユーザー取得
      operationId: getUser
      parameters:
        - required: true
          in: path
          name: userId
          description: ユーザーID
          schema:
            type: integer
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        404:
          description: ユーザーなし

  /auth/login:
    post:
      tags: [Auth]
      summary: ログイン
      operationId: login
      security: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Login"
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Token"
        404:
          description: ユーザーなし

  /auth/logout:
    post:
      tags: [Auth]
      summary: ログアウト
      operationId: logout
      responses:
        204:
          description: 成功
        401:
          description: 未認証

  /movies:
    get:
      tags: [Movie]
      summary: 映画一覧
      operationId: getMovies
      parameters:
        - name: genre
          in: query
          schema:
            type: string
          description: ジャンルコードで絞り込み
        - name: limit
          in: query
          schema:
            type: integer
            default: 12
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Movie"
        401:
          description: 未認証
        400:
          description: バッドリクエスト

  /movies/{movieId}:
    get:
      tags: [Movie]
      summary: 映画詳細
      operationId: getMovieDetail
      parameters:
        - required: true
          in: path
          name: movieId
          description: 映画ID
          schema:
            type: integer
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MovieDetail"
        401:
          description: 未認証
        404:
          description: 映画が見つからない

  /trending/movies:
    get:
      tags: [Trending]
      summary: トレンド映画一覧
      operationId: getTrendingMovies
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TrendingMovies"
        401:
          description: 未認証
        400:
          description: バッドリクエスト

  /users/me/reviews:
    get:
      tags: [Review]
      summary: マイレビュー一覧
      operationId: getMyReviews
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 12
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MyReview"
        400:
          description: バッドリクエスト
        401:
          description: 未認証

  /movies/{movieId}/reviews:
    post:
      tags: [Review]
      summary: レビュー登録
      operationId: createReview
      parameters:
        - required: true
          in: path
          name: movieId
          description: 映画ID
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateReview"
      responses:
        201:
          description: 成功
        401:
          description: 未認証
        404:
          description: 映画が見つからない
        409:
          description: 既にレビューが存在する

  /reviews/{reviewId}:
    put:
      tags: [Review]
      summary: レビュー更新
      operationId: updateReview
      parameters:
        - required: true
          in: path
          name: reviewId
          description: レビューID
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateReview"
      responses:
        204:
          description: 成功
        401:
          description: 未認証
        404:
          description: レビューが見つからない

  /users/me/watch-history:
    get:
      tags: [WatchHistory]
      summary: 視聴履歴一覧
      operationId: getWatchHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 12
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MyWatchHistory"
        401:
          description: 未認証
        400:
          description: バッドリクエスト

  /movies/{movieId}/watch-history:
    get:
      tags: [WatchHistory]
      summary: 映画の視聴履歴一覧
      operationId: getMovieWatchHistory
      parameters:
        - required: true
          in: path
          name: movieId
          description: 映画ID
          schema:
            type: integer
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WatchHistory"
        401:
          description: 未認証
        404:
          description: 映画が見つからない

    post:
      tags: [WatchHistory]
      summary: 映画の視聴履歴追加
      operationId: createMovieWatchHistory
      parameters:
        - required: true
          in: path
          name: movieId
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateWatchHistory"
      responses:
        201:
          description: 成功
        401:
          description: 未認証
        404:
          description: 映画が見つからない

  /watchlist:
    get:
      tags: [Watchlist]
      summary: ウォッチリスト一覧
      operationId: getWatchlist
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 12
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WatchlistItem"
        401:
          description: 未認証

    post:
      tags: [Watchlist]
      summary: ウォッチリスト追加
      operationId: addToWatchlist
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateWatchlistItem"
      responses:
        201:
          description: 成功
        401:
          description: 未認証

  /watchlist/{watchlistId}:
    put:
      tags: [Watchlist]
      summary: ウォッチリスト更新
      operationId: updateWatchlistItem
      parameters:
        - required: true
          in: path
          name: watchlistId
          description: ウォッチリストID
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateWatchlistItem"
      responses:
        204:
          description: 成功
        401:
          description: 未認証

    delete:
      tags: [Watchlist]
      summary: ウォッチリストから削除
      operationId: removeFromWatchlist
      parameters:
        - required: true
          in: path
          name: watchlistId
          description: ウォッチリストID
          schema:
            type: integer
      responses:
        204:
          description: 成功
        401:
          description: 未認証

  /search/movies:
    get:
      tags: [Movie, Search]
      summary: 映画検索
      operationId: searchMovies
      parameters:
        - name: title
          in: query
          required: true
          schema:
            type: string
          description: 映画タイトル
        - name: limit
          in: query
          schema:
            type: integer
            nullable: true
            default: 20
          description: 件数
        - name: offset
          in: query
          schema:
            type: integer
            nullable: true
            default: 0
          description: 取得位置
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Movie"
        401:
          description: 未認証

  /genres:
    get:
      tags: [Master]
      summary: ジャンル一覧
      operationId: getGenres
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Genre"
        401:
          description: 未認証

  /platforms:
    get:
      tags: [Master]
      summary: プラットフォーム一覧
      operationId: getPlatforms
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Platform"
        401:
          description: 未認証

  /series:
    get:
      tags: [Master]
      summary: シリーズ一覧
      operationId: getSeries
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Series"
        401:
          description: 未認証

components:
  schemas:
    CreateUser:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    User:
      type: object
      properties:
        id:
          type: integer
          description: ユーザーID
        username:
          type: string
          description: ユーザー名

    Login:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    Token:
      type: object
      properties:
        accessToken:
          type: string
          description: アクセストークン
        refreshToken:
          type: string
          description: リフレッシュトークン
        tokenType:
          type: string
          description: トークン種別
          example: Bearer
        expiresIn:
          type: integer
          description: トークンの有効時間(sec)
          example: 3600
        expiresAt:
          type: string
          description: トークンの有効期限
          format: date-time

    Movie:
      title: Movie
      type: object
      properties:
        id:
          description: ID
          type: integer
          example: 1
        title:
          description: 映画タイトル
          type: string
        overview:
          description: 映画概要
          type: string
        releaseDate:
          description: 公開日
          type: string
          format: date
        runtimeMinutes:
          description: 上映時間(分)
          type: integer
        posterURL:
          description: ポスターURL
          type: string
        tmdbID:
          description: tmdbのID
          type: integer
        genres:
          description: ジャンル一覧
          type: array
          items:
            $ref: "#/components/schemas/Genre"

    MovieDetail:
      allOf:
        - $ref: "#/components/schemas/Movie"
        - type: object
          properties:
            series:
              $ref: "#/components/schemas/Series"
            review:
              $ref: "#/components/schemas/Review"
            voteAverage:
              description: 平均評価値
              type: number
              maximum: 5.0
              minimum: 0.0
              example: 3.85
            voteCount:
              description: 平均評価数
              type: integer
              minimum: 0
              example: 12951

    TrendingMovies:
      title: TrendingMovies
      type: object
      properties:
        id:
          description: ID
          type: integer
          example: 1
        title:
          description: 映画タイトル
          type: string
        posterURL:
          description: ポスターURL
          type: string
        tmdbID:
          description: tmdbのID
          type: integer

    Genre:
      type: object
      properties:
        code:
          description: ジャンルコード
          type: string
        name:
          description: ジャンル名称
          type: string

    Platform:
      type: object
      properties:
        code:
          description: 鑑賞媒体コード
          type: string
        name:
          description: 鑑賞媒体名
          type: string

    Series:
      type: object
      properties:
        name:
          description: シリーズ名
          type: string
        posterURL:
          description: ポスターURL
          type: string

    Review:
      type: object
      properties:
        id:
          type: integer
        rating:
          description: 評価
          type: number
          format: float
        comment:
          description: 感想
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MyReview:
      type: object
      properties:
        id:
          type: integer
          description: レビューID
        rating:
          description: 評価
          type: number
          format: float
        comment:
          description: 感想
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        movie:
          $ref: "#/components/schemas/Movie"

    CreateReview:
      type: object
      properties:
        rating:
          description: 評価
          type: number
          format: float
          minimum: 0.1
          maximum: 5.0
        comment:
          description: 鑑賞記録
          type: string

    UpdateReview:
      type: object
      properties:
        rating:
          description: 評価
          type: number
          format: float
        comment:
          description: 鑑賞記録
          type: string

    WatchHistory:
      type: object
      properties:
        id:
          type: integer
        platform:
          $ref: "#/components/schemas/Platform"
        watchedAt:
          type: string
          format: date-time

    CreateWatchHistory:
      type: object
      required: [platformId]
      properties:
        platformId:
          type: integer
        watchedDate:
          type: string
          format: date

    MyWatchHistory:
      type: object
      properties:
        id:
          type: integer
        platform:
          $ref: "#/components/schemas/Platform"
        watchedAt:
          type: string
          format: date-time
        movie:
          $ref: "#/components/schemas/Movie"

    WatchlistItem:
      type: object
      properties:
        id:
          type: integer
        movie:
          $ref: "#/components/schemas/Movie"
        priority:
          type: integer
        addedAt:
          type: string
          format: date-time

    CreateWatchlistItem:
      type: object
      required: [movieId]
      properties:
        movieId:
          type: integer
        priority:
          type: integer
          default: 1

    UpdateWatchlistItem:
      type: object
      properties:
        priority:
          type: integer

  securitySchemes:
    TOKEN_HEADER:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: アクセストークン
